<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Soccer Updates</title>

    <!-- Bootstrap core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <script src="/js/vue.js"></script>
    <script src="/js/jquery-2.2.4.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/client.js"></script>
    <script>

      // when page is ready
      var app;
      var SNS;
      var potential_matches = [
        {
          match_id: 1,
          home: "Manchester United",
          away: "Liverpool",
          home_score: 0,
          away_score: 0,
          updates: []
        },
        {
          match_id: 2,
          home: "Barcelona",
          away: "Real Madrid",
          home_score: 0,
          away_score: 0,
          updates: []
        }
      ]
      $(document).ready(function() {

        app = new Vue({
          el: '#app',
          data: {
            matches: []
          },
          methods: {
            init: function() {
              
              var id = location.pathname.split("/")[2];
              potential_matches.forEach(function(pm) {
                if (pm.match_id == id) {
                  app.matches.push(pm)
                  $("title").text(pm.home + "Vs. " + pm.away);
                }
              })

              SNS = new SNSClient({
                userData: {
                  type: "soccer"
                },
                userQuery: {
                  type: "soccer"
                }
              });

              SNS.on('notification', function(n) {
                app.updateMatch(n);
              })

              $.get("/historical?type=soccer")
              .complete(function(data) {
                if (data.responseJSON && data.responseJSON.success) {
                  data.responseJSON.notifications.reverse().forEach(function(n) {
                    app.updateMatch(n);
                  })
                }
              })
              
            },
            updateMatch: function(update) {

              // find the index of the match
              var index = app.matches.findIndex(function(el, i, arr) { 
                return el.match_id == update.match_id 
              });

              // if this match isn't found, return
              if (index === -1) {
                return;
              }
                
              if (app.matches[index].home_score != update.home_score) {
                app.matches[index].home_score = update.home_score;
              }

              if (app.matches[index].away_score != update.away_score) {
                app.matches[index].away_score = update.away_score;
              }

              app.matches[index].updates.push(
                {
                  content: update.content,
                  type: update.type,
                  ts: update.ts
                }
              )

            }
          },
          computed: {
            updatesReversed: function() {
              
              var updates = [];
              this.matches.forEach(function(m) {
                
                if (typeof m.updates == "undefined") return;

                m.updates.forEach(function(u) {
                  u.home = m.home;
                  u.away = m.away;
                  updates.push(u);
                })
              })

              updates.sort(function(a, b) {
                return b.ts - a.ts;
              })
              .map(function(u) {
                var d = new Date(u.ts);
                u.time = d.getHours() + ":" + d.getMinutes();
              })

              return updates;

            },
            theMatch: function() {
              
              if (this.matches.length == 0) {
                return {
                  home: "",
                  away: "",
                  home_score: "",
                  away_score: ""
                }
              }

              return this.matches[0];
            }
          }
        });

        app.init();

      });
      
    </script>

  </head>

  <body>

    <div class="container" id="app">
      
      <div class="row">
        
        <div class="col-lg-12">
          <h1>SNS Soccer Demo</h1>
        </div>

      </div>

      <div class="row" id="chat">
        
        <div class="col-lg-8">
          <h2>{{ theMatch.home }} <b>{{ theMatch.home_score }}</b> : <b>{{ theMatch.away_score }}</b> {{ theMatch.away }}</h2>
          <div class="panel panel-{{ (update.type == 'update' ? 'info' : 'success') }}" v-for="update in updatesReversed">
            <div class="panel-heading"><b>{{ update.time }} / {{ update.type.toUpperCase() }} - {{ update.home }} Vs. {{ update.away }}</b></div>
            <div class="panel-body">
              {{ update.content }}
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <a href="/soccer" class="btn btn-primary">Back to all updates</a>
        </div>

      </div>

    </div> <!-- /container -->

  </body>
</html>
