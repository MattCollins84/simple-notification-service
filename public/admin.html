<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SNS Admin</title>

    <script src="/js/jquery-2.2.4.min.js"></script>
    <script src="/client.js"></script>
    <script>

      $(document).ready(function() {

        $.get('/authkeys')
        .complete(function(data) {
          
          if (data.responseJSON.success && data.responseJSON.keys) {
            data.responseJSON.keys.forEach(function(k) {
              var id = k.id;
              delete k.id;
              var pre = $("<pre>", { style: "margin: 10px; padding: 5px; background: #ddd"}).text(JSON.stringify(k, null, 2))
              var del = $("<button>", { type: "button", "data-del": id }).text("Delete")
              del.click(function() {
                var id = $(this).attr("data-del");
                $.ajax({
                  method: "DELETE",
                  url: "/authkey/"+id
                })
                .done(function() {
                  location.reload();
                })
              })
              $("#keys").append(pre);
              $("#keys").append(del);
              $("#keys").append($("<hr>"));
            })
          }

        });

        $("button#generate").click(function() {

          var chars = shuffle("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".split("")).join("")

          $("#key").val(chars.slice(0, 14));

        })

        $("button#submit").click(function() {

          var hostname = $("input#hostname").val()
          var key = $("input#key").val();

          $.post({
            url: "/authkey",
            data: JSON.stringify({ hostname: hostname, key: key }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function(data){
              location.reload();
            },
            error: function(err) {
              alert(err.responseJSON.error);
            }
          });

        })

      })

      function shuffle(a) {
        var j, x, i;
        for (i = a.length; i; i--) {
          j = Math.floor(Math.random() * i);
          x = a[i - 1];
          a[i - 1] = a[j];
          a[j] = x;
        }

        return a;
      }
      
    </script>

  </head>

  <body>

    <h2>Existing Keys</h2>
    <div id="keys"></div>

    <h2>Add a new key</h2>
    <form>

      <label>Hostname</label>
      <input type="text" name="hostname" id="hostname" />

      <label>API Key</label>
      <input type="text" name="key" id="key" />
      <button type="button" name="generate" id="generate">Generate Key</button>

      <br />

      <button type="button" name="submit" id="submit">Submit</button>

    </form>

  </body>
</html>
